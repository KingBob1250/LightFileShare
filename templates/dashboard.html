{% extends "base.html" %}

{% set previewable_extensions = config.PREVIEWABLE_EXTENSIONS.values() | sum(start=[]) %}

{% block title %}{{ _('Dashboard') }} - {{ _('File Server') }}{% endblock %}

{% block content %}
<div class="header">
    <h1>{{ _('File Server Dashboard') }}</h1>
    <p>{{ _('Welcome back!') }}<a href="{{ url_for('logout') }}" class="btn btn-danger">{{ _('Logout') }}</a></p>
    <p id="timezoneInfo" style="font-size: 12px; color: #666; margin-top: 5px;" 
       data-current-timezone="{{ _('Current timezone') }}" 
       data-default="{{ _('default') }}">{{ _('Detecting timezone...') }}</p>
</div>

<div class="content">
    {% if message %}
    <div class="alert alert-success">
        {{ message }}
    </div>
    {% endif %}
    
    {% if error %}
    <div class="alert alert-error">
        {{ error }}
    </div>
    {% endif %}
    
    <!-- 文件上传区域 -->
    <h2>{{ _('Upload Files') }}</h2>
    <div class="upload-area" id="uploadArea">
        <p>{{ _('Drag files here or click to select files') }}</p>
        <input type="file" id="fileInput" multiple style="display: none;">
        <button class="btn" onclick="document.getElementById('fileInput').click()">{{ _('Select Files') }}</button>
    </div>
    
    <div id="uploadProgress" style="display: none;">
        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <p id="progressText">{{ _('Uploading...') }}</p>
    </div>
    
    <!-- 导航标签页 -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('fileManagement')">{{ _('File Management') }}</button>
        <button class="nav-tab" onclick="switchTab('shareManagement')">{{ _('Share Management') }}</button>
    </div>
    
    <!-- 文件列表 -->
    <div id="fileManagementContent">
        <h2>{{ _('File List') }}</h2>
        <div class="form-group">
            <input type="text" id="searchInput" placeholder="{{ _('Search files...') }}" onkeyup="debounceSearch()">
            <div id="searchStatus" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
        </div>
        
        <!-- 批量操作控件 -->
        <div class="batch-controls" id="batchControls" style="display: none;">
            <div class="batch-info">
                <span id="selectedCount">{{ _('Selected 0 files') }}</span>
            </div>
            <div class="batch-actions">
                <button class="btn btn-success" onclick="batchShare()">{{ _('Batch Share') }}</button>
                <button class="btn btn-primary" onclick="batchDownload()">{{ _('Batch Download') }}</button>
                <button class="btn btn-danger" onclick="batchDelete()">{{ _('Batch Delete') }}</button>
                <button class="btn" onclick="clearSelection()">{{ _('Clear Selection') }}</button>
            </div>
        </div>
        
        <div id="fileListContainer">
            <table class="table" id="fileTable">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            <label for="selectAll">{{ _('Select All') }}</label>
                        </th>
                        <th class="sortable" onclick="sortBy('original_filename')" data-sort="original_filename">
                            {{ _('Filename') }} <span class="sort-icon"></span>
                        </th>
                        <th class="sortable" onclick="sortBy('file_size')" data-sort="file_size">
                            {{ _('Size') }} <span class="sort-icon"></span>
                        </th>
                        <th class="sortable" onclick="sortBy('upload_time')" data-sort="upload_time">
                            {{ _('Upload Time') }} <span class="sort-icon"></span>
                        </th>
                        <th class="sortable" onclick="sortBy('share_status')" data-sort="share_status">
                            {{ _('Share Status') }} <span class="sort-icon"></span>
                        </th>
                        <th>{{ _('Actions') }}</th>
                    </tr>
                </thead>
                <tbody id="fileTableBody">
                    {% for file in files %}
                    <tr data-filename="{{ file.original_filename.lower() }}" data-file-id="{{ file.id }}">
                        <td>
                            <input type="checkbox" class="file-checkbox" value="{{ file.id }}" onchange="updateSelection()">
                        </td>
                        <td>{{ file.original_filename }}</td>
                        <td>{{ file.file_size_human }}</td>
                        <td>{{ file.get_local_time(timezone).strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td>
                            {% if file.shares %}
                                {% for share in file.shares %}
                                    {% if not share.is_expired %}
                                        <span class="btn btn-success share-status" 
                                              style="font-size: 12px; padding: 4px 8px; cursor: pointer;"
                                              onclick="copyShareInfo('{{ file.original_filename }}', '{{ share_host }}/download/{{ share.token }}')"
                                              title="{{ _('Click to copy share information') }}">
                                            {{ _('Sharing') }} ({{ share.days_remaining }}{{ _('days') }})
                                        </span>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <span style="color: #999;">{{ _('Not shared') }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="actions-container">
                                {% if file.original_filename.rsplit('.', 1)[-1].lower() in previewable_extensions %}
                                <button class="btn btn-info" onclick="showPreviewModal({{ file.id }}, '{{ file.original_filename }}')">{{ _('Preview') }}</button>
                                {% endif %}
                                <button class="btn btn-primary" onclick="downloadFile({{ file.id }})">{{ _('Download') }}</button>
                                <button class="btn" onclick="showShareModal({{ file.id }}, '{{ file.original_filename }}')">{{ _('Share') }}</button>
                                <button class="btn btn-danger" onclick="confirmDelete({{ file.id }}, '{{ file.original_filename }}')">{{ _('Delete') }}</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            {% if not files %}
            <p style="text-align: center; color: #999; margin-top: 20px;">{{ _('No files found') }}</p>
            {% endif %}
            
            <!-- 分页控件 -->
            {% if pagination and pagination.pages > 1 %}
            <div class="pagination">
                {% if pagination.has_prev %}
                    <a href="{{ url_for('dashboard', page=pagination.prev_num) }}" class="btn">&laquo; {{ _('Previous Page') }}</a>
                {% endif %}
                
                <span class="pagination-info">
                    {{ _('Page') }} {{ pagination.page }} {{ _('of') }} {{ pagination.pages }}
                    ({{ _('Total') }} {{ pagination.total }} {{ _('files') }})
                </span>
                
                {% if pagination.has_next %}
                    <a href="{{ url_for('dashboard', page=pagination.next_num) }}" class="btn">{{ _('Next Page') }} &raquo;</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 分享管理界面 -->
<div class="content" id="shareManagementContent" style="display: none;">
    <h2>{{ _('Share Management') }}</h2>
    <div class="share-controls">
        <button class="btn" onclick="refreshShares()">{{ _('Refresh') }}</button>
        <button class="btn btn-danger" onclick="stopAllShares()">{{ _('Stop All Shares') }}</button>
    </div>
    
    <div id="shareListContainer">
        <table class="table" id="shareTable">
            <thead>
                <tr>
                    <th>
                        <input type="checkbox" id="selectAllShares" onchange="toggleSelectAllShares()">
                        <label for="selectAllShares">{{ _('Select All') }}</label>
                    </th>
                    <th>{{ _('Filename') }}</th>
                    <th>{{ _('Link') }}</th>
                    <th>{{ _('Created Time') }}</th>
                    <th>{{ _('Expire Time') }}</th>
                    <th>{{ _('Remaining Days') }}</th>
                    <th>{{ _('Access Count') }}</th>
                    <th>{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody id="shareTableBody">
                <!-- 分享链接列表将在这里动态生成 -->
            </tbody>
        </table>
        
        <div id="noSharesMessage" style="text-align: center; color: #999; margin-top: 20px; display: none;">
            {{ _('No share links found') }}
        </div>
    </div>
</div>

<!-- 分享模态框 -->
<div id="shareModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideModal('shareModal')">&times;</span>
        <h3>{{ _('Share File') }}</h3>
        <p id="shareFileName"></p>
        
        <form id="shareForm">
            <div class="form-group">
                <label for="shareDays">{{ _('Share Days') }}：</label>
                <select id="shareDays" name="days">
                    <option value="1">{{ _('1 day') }}</option>
                    <option value="3">{{ _('3 days') }}</option>
                    <option value="7" selected>{{ _('7 days') }}</option>
                    <option value="15">{{ _('15 days') }}</option>
                    <option value="30">{{ _('30 days') }}</option>
                </select>
            </div>
            
            <button type="submit" class="btn btn-success">{{ _('Generate Share Link') }}</button>
        </form>
        
        <div id="shareResult" style="display: none; margin-top: 20px;">
            <h4>{{ _('Share Information') }}：</h4>
            <div style="background: #f5f5f5; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                <strong>{{ _('Filename') }}：</strong><span id="shareFileNameResult"></span>
            </div>
            <div style="background: #f5f5f5; padding: 10px; border-radius: 4px; word-break: break-all; margin-bottom: 10px;">
                <strong>{{ _('Share Link') }}：</strong><span id="shareLink"></span>
            </div>
            <button class="btn" onclick="copyShareInfo()">{{ _('Copy Share Link') }}</button>
        </div>
    </div>
</div>

<!-- 批量分享模态框 -->
<div id="batchShareModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideModal('batchShareModal')">&times;</span>
        <h3>{{ _('Batch Share Files') }}</h3>
        <p id="batchShareCount"></p>
        
        <form id="batchShareForm">
            <div class="form-group">
                <label for="batchShareDays">{{ _('Share Days') }}：</label>
                <select id="batchShareDays" name="days">
                    <option value="1">{{ _('1 day') }}</option>
                    <option value="3">{{ _('3 days') }}</option>
                    <option value="7" selected>{{ _('7 days') }}</option>
                    <option value="15">{{ _('15 days') }}</option>
                    <option value="30">{{ _('30 days') }}</option>
                </select>
            </div>
            
            <button type="submit" class="btn btn-success">{{ _('Generate Batch Share Links') }}</button>
        </form>
        
        <div id="batchShareResult" style="display: none; margin-top: 20px;">
            <h4>{{ _('Batch Share Results') }}：</h4>
            <div id="batchShareLinks" style="max-height: 300px; overflow-y: auto;">
                <!-- 分享链接列表将在这里动态生成 -->
            </div>
            <button class="btn" onclick="copyAllShareLinks()">{{ _('Copy All Share Links') }}</button>
        </div>
    </div>
</div>

<!-- 预览模态框 -->
<div id="previewModal" class="modal">
    <div class="modal-content preview-modal-content">
        <div class="preview-header">
            <h3 id="previewTitle"></h3>
            <span class="close" onclick="hidePreviewModal()">&times;</span>
        </div>
        <div id="previewContent" class="preview-content">
            <!-- 预览内容将在这里动态生成 -->
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // 翻译文本
    const translations = {
        currentTimezone: "{{ _('Current timezone') }}",
        default: "{{ _('default') }}",
        uploadCompleted: "{{ _('Upload completed!') }}",
        filename: "{{ _('Filename') }}",
        downloadLink: "{{ _('Download link') }}",
        linkCopied: "{{ _('Link copied to clipboard!') }}",
        copyFailed: "{{ _('Copy failed') }}",
        confirmStopShare: "{{ _('Are you sure you want to stop this share link?') }}",
        shareLinkStopped: "{{ _('Share link stopped') }}",
        stopShareFailed: "{{ _('Stop share failed') }}",
        preview: "{{ _('Preview') }}",
        searching: "{{ _('Searching...') }}",
        loading: "{{ _('Loading...') }}",
        foundFiles: "{{ _('Found') }}",
        totalFiles: "{{ _('Total') }}",
        files: "{{ _('files') }}",
        uploadFailed: "{{ _('Upload failed') }}",
        uploadFailedParse: "{{ _('Upload failed: Unable to parse server response') }}",
        uploadFailedSize: "{{ _('Upload failed: File size exceeds server limit') }}",
        uploadFailedNetwork: "{{ _('Upload failed: Network error') }}",
        uploading: "{{ _('Uploading') }}",
        uploadProgress: "{{ _('Uploading') }} %s: %.1f%%",
        copy: "{{ _('Copy') }}",
        stopShare: "{{ _('Stop Share') }}",
        noShareLinksToCopy: "{{ _('No share links to copy') }}",
        batchShareLinks: "{{ _('Batch share links') }}",
        pleaseSelectFilesToDownload: "{{ _('Please select files to download') }}",
        pleaseSelectSharesToStop: "{{ _('Please select shares to stop') }}",
        confirmStopSelectedShares: "{{ _('Are you sure you want to stop selected') }}",
        shareLinks: "{{ _('share links') }}",
        successfullyStopped: "{{ _('Successfully stopped') }}",
        failedTimes: "{{ _('failed') }}",
        times: "{{ _('times') }}",
        days: "{{ _('days') }}",
        sharing: "{{ _('Sharing') }}"
    };

    let currentFileId = null;
    let currentFileName = '';
    let searchTimeout = null;
    let currentPage = 1;
    let selectedFiles = new Set(); // 存储选中的文件ID
    let batchShareResults = []; // 存储批量分享结果
    let currentSortBy = 'upload_time';
    let currentSortOrder = 'desc';
    let userTimezone = null; // 用户时区

    // 检测用户时区
    function detectUserTimezone() {
        try {
            userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            console.log('检测到用户时区:', userTimezone);
            
            // 更新页面上的时区显示
            const timezoneInfo = document.getElementById('timezoneInfo');
            if (timezoneInfo) {
                timezoneInfo.textContent = `${translations.currentTimezone}: ${userTimezone}`;
            }
        } catch (e) {
            userTimezone = 'Asia/Shanghai'; // 默认时区
            console.log('时区检测失败，使用默认时区:', userTimezone);
            
            // 更新页面上的时区显示
            const timezoneInfo = document.getElementById('timezoneInfo');
            if (timezoneInfo) {
                timezoneInfo.textContent = `${translations.currentTimezone}: ${userTimezone} (${translations.default})`;
            }
        }
    }

    // 转换UTC时间为本地时间
    function convertUTCToLocal(utcString) {
        if (!utcString) return '';
        
        try {
            const utcDate = new Date(utcString);
            if (isNaN(utcDate.getTime())) {
                return utcString; // 如果解析失败，返回原字符串
            }
            
            return utcDate.toLocaleString('zh-CN', {
                timeZone: userTimezone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        } catch (e) {
            console.error('时间转换失败:', e);
            return utcString;
        }
    }

    // 格式化时间显示
    function formatTimeDisplay(utcString) {
        const localTime = convertUTCToLocal(utcString);
        return localTime;
    }

    // 文件上传功能
    document.getElementById('fileInput').addEventListener('change', handleFileSelect);
    document.getElementById('uploadArea').addEventListener('dragover', handleDragOver);
    document.getElementById('uploadArea').addEventListener('drop', handleDrop);

    // 批量分享表单事件
    document.getElementById('batchShareForm').addEventListener('submit', function(e) {
        e.preventDefault();
        performBatchShare();
    });

    function handleFileSelect(event) {
        const files = event.target.files;
        uploadFiles(files);
    }

    function handleDragOver(event) {
        event.preventDefault();
        event.currentTarget.classList.add('dragover');
    }

    function handleDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.remove('dragover');
        const files = event.dataTransfer.files;
        uploadFiles(files);
    }

    function uploadFiles(files) {
        const progressDiv = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        
        progressDiv.style.display = 'block';
        
        for (let file of files) {
            const formData = new FormData();
            formData.append('file', file);
            
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressBar.style.width = percentComplete + '%';
                    progressText.textContent = `${translations.uploading} ${file.name}: ${percentComplete.toFixed(1)}%`;
                }
            });
            
            xhr.addEventListener('load', function() {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.success) {
                            progressText.textContent = `${file.name} ${translations.uploadCompleted}`;
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        } else {
                            progressText.textContent = `${file.name} ${translations.uploadFailed}: ${response.error || 'Unknown error'}`;
                            progressText.style.color = 'red';
                        }
                    } catch (e) {
                        progressText.textContent = `${file.name} ${translations.uploadFailedParse}`;
                        progressText.style.color = 'red';
                    }
                } else if (xhr.status === 413) {
                    const max_size_mb = {{ (config.MAX_CONTENT_LENGTH / (1024*1024)) | round | int }};
                    progressText.textContent = `${file.name} ${translations.uploadFailedSize} (${max_size_mb} MB)`;
                    progressText.style.color = 'red';
                } else {
                    let errorMessage = `Server error (HTTP ${xhr.status})`;
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response && response.error) {
                            errorMessage = response.error;
                        }
                    } catch (e) {
                        // 响应不是JSON格式，使用默认错误信息
                    }
                    progressText.textContent = `${file.name} ${translations.uploadFailed}: ${errorMessage}`;
                    progressText.style.color = 'red';
                }
            });
            
            xhr.addEventListener('error', function() {
                progressText.textContent = `${file.name} ${translations.uploadFailedNetwork}`;
                progressText.style.color = 'red';
            });
            
            xhr.open('POST', '/upload');
            xhr.send(formData);
        }
    }

    // 防抖搜索功能
    function debounceSearch() {
        const searchStatus = document.getElementById('searchStatus');
        searchStatus.textContent = translations.searching;
        
        // 清除之前的定时器
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        
        // 设置新的定时器（300ms防抖）
        searchTimeout = setTimeout(() => {
            performSearch(1); // 搜索时重置到第一页
        }, 300);
    }

    // 执行搜索、分页和排序
    function performSearch(page = 1) {
        const input = document.getElementById('searchInput');
        const query = input.value.trim();
        const searchStatus = document.getElementById('searchStatus');
        currentPage = page;
        
        // 构建API URL
        let url = `/api/search_files?page=${currentPage}&per_page=20`;
        if (query) {
            url += `&q=${encodeURIComponent(query)}`;
        }
        url += `&sort_by=${currentSortBy}&sort_order=${currentSortOrder}`;
        
        // 显示加载状态
        searchStatus.textContent = translations.loading;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                updateFileTable(data.files, data.pagination);
                
                // 更新搜索状态
                const total = data.pagination.total;
                if (query) {
                    searchStatus.textContent = `${translations.foundFiles} ${total} ${translations.files}`;
                } else {
                    searchStatus.textContent = `${translations.totalFiles} ${total} ${translations.files}`;
                }
                updateSortIcons();
            })
            .catch(error => {
                console.error('加载失败:', error);
                searchStatus.textContent = '加载失败，请重试';
            });
    }

    // 更新排序图标
    function updateSortIcons() {
        document.querySelectorAll('.sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
        });
        
        const activeHeader = document.querySelector(`.sortable[data-sort="${currentSortBy}"]`);
        if (activeHeader) {
            activeHeader.classList.add(currentSortOrder);
        }
    }

    // 按列排序
    function sortBy(column) {
        if (currentSortBy === column) {
            currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortBy = column;
            currentSortOrder = 'desc'; // 默认降序
        }
        performSearch(1); // 排序时重置到第一页
    }

    // 更新文件表格
    function updateFileTable(files, pagination) {
        const tbody = document.getElementById('fileTableBody');
        const container = document.getElementById('fileListContainer');
        
        // 清空表格内容
        tbody.innerHTML = '';
        
        if (files.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No files found</td></tr>';
        } else {
            // 添加文件行
            files.forEach(file => {
                const row = document.createElement('tr');
                row.setAttribute('data-filename', file.filename.toLowerCase());
                row.setAttribute('data-file-id', file.id);
                
                // 构建分享状态HTML
                let sharesHtml = '<span style="color: #999;">Not shared</span>';
                if (file.shares && file.shares.length > 0) {
                    sharesHtml = file.shares.map(share => 
                        `<span class="btn btn-success share-status" 
                              style="font-size: 12px; padding: 4px 8px; cursor: pointer;"
                              onclick="copyShareInfo('${file.filename}', '${window.location.origin}/download/${share.token}')"
                              title="{{ _('Click to copy share information') }}">
                            ${translations.sharing} (${share.days_remaining}${translations.days})
                        </span>`
                    ).join('');
                }
                
                let previewButton = '';
                const ext = file.filename.split('.').pop().toLowerCase();
                const previewable_extensions_flat = {{ previewable_extensions | tojson }};
                if (previewable_extensions_flat.includes(ext)) {
                    previewButton = `<button class="btn btn-info" onclick="showPreviewModal(${file.id}, '${file.filename}')">{{ _('Preview') }}</button>`;
                }
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="file-checkbox" value="${file.id}" onchange="updateSelection()">
                    </td>
                    <td>${file.filename}</td>
                    <td>${file.size_human}</td>
                    <td>${formatTimeDisplay(file.upload_time_utc)}</td>
                    <td>${sharesHtml}</td>
                    <td>
                        <div class="actions-container">
                            ${previewButton}
                            <button class="btn btn-primary" onclick="downloadFile(${file.id})">{{ _('Download') }}</button>
                            <button class="btn" onclick="showShareModal(${file.id}, '${file.filename}')">{{ _('Share') }}</button>
                            <button class="btn btn-danger" onclick="confirmDelete(${file.id}, '${file.filename}')">{{ _('Delete') }}</button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // 更新分页控件
        updatePagination(pagination);
        
        // 重置选择状态
        clearSelection();
    }

    // 更新分页控件
    function updatePagination(pagination) {
        const container = document.getElementById('fileListContainer');
        
        // 查找现有的分页控件
        let existingPagination = container.querySelector('.pagination');
        if (existingPagination) {
            existingPagination.remove();
        }
        
        // 如果有多页，创建新的分页控件
        if (pagination.pages > 1) {
            const paginationDiv = document.createElement('div');
            paginationDiv.className = 'pagination';
            
            let paginationHtml = '';
            
            if (pagination.has_prev) {
                paginationHtml += `<a href="#" onclick="changePage(${pagination.prev_num})" class="btn">&laquo; {{ _('Previous Page') }}</a>`;
            }
            
            paginationHtml += `<span class="pagination-info">
                第 ${pagination.page} 页，共 ${pagination.pages} 页
                (总计 ${pagination.total} 个文件)
            </span>`;
            
            if (pagination.has_next) {
                paginationHtml += `<a href="#" onclick="changePage(${pagination.next_num})" class="btn">{{ _('Next Page') }} &raquo;</a>`;
            }
            
            paginationDiv.innerHTML = paginationHtml;
            container.appendChild(paginationDiv);
        }
    }

    // 切换页面
    function changePage(page) {
        performSearch(page);
    }

    function showPreviewModal(fileId, filename) {
        const previewModal = document.getElementById('previewModal');
        const previewTitle = document.getElementById('previewTitle');
        const previewContent = document.getElementById('previewContent');
        
        previewTitle.textContent = `${translations.preview}: ${filename}`;
        previewContent.innerHTML = '<p style="text-align: center;">{{ _("Loading...") }}</p>';
        previewModal.style.display = 'flex';

        const ext = filename.split('.').pop().toLowerCase();
        const previewUrl = `/preview/${fileId}`;

        const previewable_config = {{ config.PREVIEWABLE_EXTENSIONS | tojson }};

        let element;

        if (previewable_config.image.includes(ext)) {
            element = document.createElement('img');
            element.src = previewUrl;
            element.style.maxWidth = '100%';
            element.style.maxHeight = '100%';
            element.style.display = 'block';
            element.style.margin = 'auto';
        } else if (previewable_config.video.includes(ext)) {
            element = document.createElement('video');
            element.src = previewUrl;
            element.controls = true;
            element.autoplay = true;
            element.style.maxWidth = '100%';
            element.style.maxHeight = '100%';
        } else if (previewable_config.audio.includes(ext)) {
            element = document.createElement('audio');
            element.src = previewUrl;
            element.controls = true;
            element.autoplay = true;
            element.style.width = '100%';
        } else { // pdf, text, etc.
            element = document.createElement('iframe');
            element.src = previewUrl;
            element.style.width = '100%';
            element.style.height = '100%';
            element.style.border = 'none';
        }

        previewContent.innerHTML = '';
        previewContent.appendChild(element);
    }

    // 分享功能
    function showShareModal(fileId, filename) {
        currentFileId = fileId;
        currentFileName = filename;
        document.getElementById('shareFileName').textContent = filename;
        document.getElementById('shareResult').style.display = 'none';
        showModal('shareModal');
    }

    document.getElementById('shareForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const days = document.getElementById('shareDays').value;
        
        fetch('/share', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                file_id: currentFileId,
                days: parseInt(days)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('shareFileNameResult').textContent = data.filename;
                document.getElementById('shareLink').textContent = data.share_url;
                document.getElementById('shareResult').style.display = 'block';
            } else {
                alert('Failed to create share link: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to create share link');
        });
    });

    function copyShareInfo(filename, shareUrl) {
        // 如果传入了参数，使用传入的参数；否则从DOM获取
        if (filename && shareUrl) {
            const fullInfo = `${translations.filename}: ${filename}\n${translations.downloadLink}: ${shareUrl}`;
            copyToClipboard(fullInfo);
        } else {
            const filename = document.getElementById('shareFileNameResult').textContent;
            const link = document.getElementById('shareLink').textContent;
            const fullInfo = `${translations.filename}: ${filename}\n${translations.downloadLink}: ${link}`;
            copyToClipboard(fullInfo);
        }
    }

    // 下载文件功能
    function downloadFile(fileId) {
        // 创建一个隐藏的链接来触发下载
        const link = document.createElement('a');
        link.href = `/download_file/${fileId}`;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // 删除确认功能
    function confirmDelete(fileId, filename) {
        if (confirm(`Are you sure you want to delete file "${filename}"?`)) {
            window.location.href = `/delete/${fileId}`;
        }
    }

    // 模态框功能
    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'flex';
        }
    }

    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
        }
    }

    function hidePreviewModal() {
        const modal = document.getElementById('previewModal');
        modal.style.display = 'none';
        // 停止视频或音频的播放
        const content = document.getElementById('previewContent');
        const mediaElement = content.querySelector('video, audio');
        if (mediaElement) {
            mediaElement.pause();
            mediaElement.src = '';
        }
        content.innerHTML = '';
    }

    // 复制到剪贴板功能
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            alert(translations.linkCopied);
        }, function(err) {
            console.error('复制失败:', err);
            // 备用方案
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert(translations.linkCopied);
        });
    }

    // 批量操作相关函数
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.file-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
            if (selectAll.checked) {
                selectedFiles.add(parseInt(checkbox.value));
            } else {
                selectedFiles.delete(parseInt(checkbox.value));
            }
        });
        
        updateSelection();
    }

    function updateSelection() {
        const checkboxes = document.querySelectorAll('.file-checkbox');
        const selectAll = document.getElementById('selectAll');
        const batchControls = document.getElementById('batchControls');
        const selectedCount = document.getElementById('selectedCount');
        
        // 清空选择集合
        selectedFiles.clear();
        
        // 重新计算选中的文件
        let checkedCount = 0;
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                selectedFiles.add(parseInt(checkbox.value));
                checkedCount++;
            }
        });
        
        // 更新全选状态
        selectAll.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
        selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        
        // 更新批量操作控件显示
        if (selectedFiles.size > 0) {
            batchControls.style.display = 'block';
            selectedCount.textContent = `Selected ${selectedFiles.size} files`;
        } else {
            batchControls.style.display = 'none';
        }
    }

    function clearSelection() {
        const checkboxes = document.querySelectorAll('.file-checkbox');
        const selectAll = document.getElementById('selectAll');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        selectAll.checked = false;
        selectAll.indeterminate = false;
        selectedFiles.clear();
        updateSelection();
    }

    function batchDelete() {
        if (selectedFiles.size === 0) {
            alert('Please select files to delete');
            return;
        }
        
        if (!confirm(`Are you sure you want to delete selected ${selectedFiles.size} files? This operation cannot be undone!`)) {
            return;
        }
        
        fetch('/api/batch_delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                file_ids: Array.from(selectedFiles)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                clearSelection();
                // 刷新文件列表
                performSearch();
            } else {
                alert('Batch delete failed: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Batch delete failed');
        });
    }

    function batchShare() {
        if (selectedFiles.size === 0) {
            alert('Please select files to share');
            return;
        }
        
        document.getElementById('batchShareCount').textContent = `Sharing ${selectedFiles.size} files`;
        document.getElementById('batchShareResult').style.display = 'none';
        showModal('batchShareModal');
    }

    function performBatchShare() {
        const days = document.getElementById('batchShareDays').value;
        
        fetch('/api/batch_share', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                file_ids: Array.from(selectedFiles),
                days: parseInt(days)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                batchShareResults = data.share_links;
                displayBatchShareResults(data);
            } else {
                alert('Batch share failed: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Batch share failed');
        });
    }

    function displayBatchShareResults(data) {
        const resultDiv = document.getElementById('batchShareResult');
        const linksDiv = document.getElementById('batchShareLinks');
        
        let html = `<p><strong>Successfully shared ${data.shared_count} files</strong></p>`;
        
        if (data.share_links.length > 0) {
            html += '<div style="background: #f5f5f5; padding: 10px; border-radius: 4px; margin-bottom: 10px;">';
            data.share_links.forEach(link => {
                html += `
                    <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
                        <strong>${link.filename}</strong><br>
                        <small style="color: #666;">${link.share_url}</small>
                    </div>
                `;
            });
            html += '</div>';
        }
        
        if (data.failed_files.length > 0) {
            html += '<p style="color: red;"><strong>Failed files:</strong></p>';
            html += '<ul style="color: red;">';
            data.failed_files.forEach(fail => {
                html += `<li>${fail}</li>`;
            });
            html += '</ul>';
        }
        
        linksDiv.innerHTML = html;
        resultDiv.style.display = 'block';
    }

    function copyAllShareLinks() {
        if (batchShareResults.length === 0) {
            alert(translations.noShareLinksToCopy);
            return;
        }
        
        let text = `${translations.batchShareLinks}:\n\n`;
        batchShareResults.forEach(link => {
            text += `${translations.filename}: ${link.filename}\n${translations.downloadLink}: ${link.share_url}\n\n`;
        });
        
        copyToClipboard(text);
    }

    function batchDownload() {
        if (selectedFiles.size === 0) {
            alert(translations.pleaseSelectFilesToDownload);
            return;
        }
        
        // 创建下载链接
        const fileIds = JSON.stringify(Array.from(selectedFiles));
        const downloadUrl = `/api/batch_download?file_ids=${encodeURIComponent(fileIds)}`;
        
        // 创建一个隐藏的链接来触发下载
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    document.addEventListener('DOMContentLoaded', function() {
        detectUserTimezone();
        updateSortIcons();
        // 初始化时加载分享列表
        loadShares();
    });

    // 标签页切换功能
    function switchTab(tabName) {
        // 更新标签页状态
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // 切换内容显示
        if (tabName === 'fileManagement') {
            document.getElementById('fileManagementContent').style.display = 'block';
            document.getElementById('shareManagementContent').style.display = 'none';
        } else if (tabName === 'shareManagement') {
            document.getElementById('fileManagementContent').style.display = 'none';
            document.getElementById('shareManagementContent').style.display = 'block';
            loadShares(); // 切换到分享管理时加载分享列表
        }
    }

    // 分享管理功能
    function loadShares() {
        fetch('/api/shares')
            .then(response => response.json())
            .then(shares => {
                displayShares(shares);
            })
            .catch(error => {
                console.error('加载分享列表失败:', error);
            });
    }

    function displayShares(shares) {
        const tbody = document.getElementById('shareTableBody');
        const noSharesMessage = document.getElementById('noSharesMessage');
        
        if (shares.length === 0) {
            tbody.innerHTML = '';
            noSharesMessage.style.display = 'block';
            return;
        }
        
        noSharesMessage.style.display = 'none';
        
        let html = '';
        shares.forEach(share => {
            const shareUrl = `${window.location.origin}/download/${share.token}`;
            const createdTime = formatTimeDisplay(share.created_time_utc);
            const expireTime = formatTimeDisplay(share.expire_time_utc);
            
            html += `
                <tr>
                    <td>
                        <input type="checkbox" class="share-checkbox" value="${share.id}">
                    </td>
                    <td>${share.filename}</td>
                    <td>
                        <div class="actions-container">
                            <button class="btn" onclick="copyToClipboard('${shareUrl}')">${translations.copy}</button>
                        </div>
                    </td>
                    <td>${createdTime}</td>
                    <td>${expireTime}</td>
                    <td>${share.days_remaining}${translations.days}</td>
                    <td>${share.download_count}</td>
                    <td>
                        <div class="actions-container">
                            <button class="btn btn-danger" onclick="stopShare(${share.id})">${translations.stopShare}</button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
    }

    function refreshShares() {
        loadShares();
    }

    function stopShare(shareId) {
        if (!confirm(translations.confirmStopShare)) {
            return;
        }
        
        fetch(`/api/delete_share/${shareId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(translations.shareLinkStopped);
                loadShares(); // 重新加载分享列表
            } else {
                alert(translations.stopShareFailed);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(translations.stopShareFailed);
        });
    }

    function toggleSelectAllShares() {
        const selectAll = document.getElementById('selectAllShares');
        const checkboxes = document.querySelectorAll('.share-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
    }

    function stopAllShares() {
        const checkboxes = document.querySelectorAll('.share-checkbox:checked');
        const selectedShares = Array.from(checkboxes).map(cb => parseInt(cb.value));
        
        if (selectedShares.length === 0) {
            alert(translations.pleaseSelectSharesToStop);
            return;
        }
        
        if (!confirm(`${translations.confirmStopSelectedShares} ${selectedShares.length} ${translations.shareLinks}?`)) {
            return;
        }
        
        // 逐个停止分享链接
        let stoppedCount = 0;
        let failedCount = 0;
        
        const stopPromises = selectedShares.map(shareId => 
            fetch(`/api/delete_share/${shareId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        stoppedCount++;
                    } else {
                        failedCount++;
                    }
                })
                .catch(() => {
                    failedCount++;
                })
        );
        
        Promise.all(stopPromises).then(() => {
            let message = `${translations.successfullyStopped} ${stoppedCount} ${translations.shareLinks}`;
            if (failedCount > 0) {
                message += `, ${translations.failedTimes} ${failedCount} ${translations.times}`;
            }
            alert(message);
            loadShares(); // 重新加载分享列表
        });
    }
</script>
{% endblock %} 